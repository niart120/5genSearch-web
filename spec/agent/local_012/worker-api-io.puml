@startuml worker-api-io
' =========================================
' Worker 経由 WASM API の Input/Output 可視化
' =========================================
' local_012: API Input/Output 正規化 仕様書
' 目的: TS 側から見た Searcher/Generator の入出力を整理
' =========================================

' レイアウト設定
scale 0.8
left to right direction

skinparam packageStyle rectangle
skinparam linetype ortho
skinparam nodesep 15
skinparam ranksep 30

' ===== カラー定義 =====
skinparam package {
    BackgroundColor<<searcher>> #E3F2FD
    BackgroundColor<<generator>> #E8F5E9
    BackgroundColor<<input>> #FFF3E0
    BackgroundColor<<output>> #F3E5F5
    BackgroundColor<<shared>> #ECEFF1
}

skinparam class {
    BackgroundColor<<params>> #FFFDE7
    BackgroundColor<<result>> #E1F5FE
    BackgroundColor<<config>> #FCE4EC
}

' =========================================
' 共通入力型 (Shared Input Types)
' =========================================
package "共通入力型" <<shared>> {
    class DsConfig <<config>> {
        mac: [u8; 6]
        hardware: Hardware
        version: RomVersion
        region: RomRegion
    }

    class DatetimeParams <<config>> {
        year: number
        month: number
        day: number
        hour: number
        minute: number
        second: number
    }

    class SearchSegment <<config>> {
        timer0: number
        vcount: number
        key_code: KeyCode
    }

    class TimeRangeParams <<config>> {
        hour_start/end: number
        minute_start/end: number
        second_start/end: number
    }

    class SearchRangeParams <<config>> {
        start_year/month/day: number
        start_second_offset: number
        range_seconds: number
    }

    class VCountTimer0Range <<config>> {
        vcount: number
        timer0_min: number
        timer0_max: number
    }

    class IvFilter <<config>> {
        hp/atk/def/spa/spd/spe: [min, max]
        hidden_power_types?: HiddenPowerType[]
        hidden_power_min_power?: number
    }

    enum "SeedSource" as SeedSource <<params>> {
        Seed { initial_seed: LcgSeed }
        MultipleSeeds { seeds: LcgSeed[] }
        Startup { ds, datetime, segments }
        StartupRange { ds, datetime, ranges, key_code }
    }
}

' =========================================
' Searcher APIs (検索系)
' =========================================
package "Searcher APIs" <<searcher>> {

    ' ----- MtseedSearcher -----
    package "MtseedSearcher" {
        class MtseedSearchParams <<params>> {
            iv_filter: IvFilter
            mt_offset: number
            is_roamer: boolean
        }

        class MtseedSearchBatch <<result>> {
            candidates: MtseedResult[]
            processed: bigint
            total: bigint
        }

        class MtseedResult <<result>> {
            seed: MtSeed
            ivs: Ivs
        }
    }

    ' ----- MtseedDatetimeSearcher -----
    package "MtseedDatetimeSearcher" {
        class MtseedDatetimeSearchParams <<params>> {
            target_seeds: MtSeed[]
            ds: DsConfig
            time_range: TimeRangeParams
            search_range: SearchRangeParams
            segment: SearchSegment
        }

        class MtseedDatetimeSearchBatch <<result>> {
            results: MtseedDatetimeResult[]
            processed_seconds: number
            total_seconds: number
        }

        class MtseedDatetimeResult <<result>> {
            seed: MtSeed
            datetime: DatetimeParams
            segment: SearchSegment
        }
    }

    ' ----- NeedleSearcher -----
    package "NeedleSearcher" {
        class NeedleSearchParams <<params>> {
            input: SeedSource
            pattern: NeedlePattern
            advance_min: number
            advance_max: number
        }

        class NeedleSearchBatch <<result>> {
            results: NeedleSearchResult[]
            processed: number
            total: number
        }

        class NeedleSearchResult <<result>> {
            advance: number
            source: GenerationSource
        }
    }
}

' =========================================
' Generator APIs (生成系)
' =========================================
package "Generator APIs" <<generator>> {

    note as GeneratorNote
        現状、Generator は WASM API として
        直接公開されていない。
        Rust 内部でのみ使用される。
        
        今後 Worker 経由で公開する場合の
        想定インターフェースを定義。
    end note

    ' ----- WildPokemonGenerator (想定) -----
    package "WildPokemonGenerator (内部)" {
        class "PokemonGenerationConfig\n(内部型)" as PokemonGenerationConfig <<config>> {
            version: RomVersion
            encounter_type: EncounterType
            tid/sid: u16
            lead_ability: LeadAbilityEffect
            shiny_charm: boolean
            shiny_locked: boolean
            has_held_item: boolean
            encounter_method: EncounterMethod
        }

        class "EncounterSlotConfig\n(内部型)" as EncounterSlotConfig <<config>> {
            species_id: u16
            level_min/max: u8
            gender_threshold: u8
            has_held_item: boolean
        }

        class "OffsetConfig\n(内部型)" as OffsetConfig <<config>> {
            user_offset: u32
            mt_offset: u32
        }
    }

    ' ----- EggGenerator (想定) -----
    package "EggGenerator (内部)" {
        class "EggGenerationConfig\n(内部型)" as EggGenerationConfig <<config>> {
            tid/sid: u16
            everstone: EverstonePlan
            female_has_hidden: boolean
            uses_ditto: boolean
            gender_ratio: GenderRatio
            nidoran_flag: boolean
            pid_reroll_count: u8
        }
    }
}

' =========================================
' 共通出力型 (Shared Output Types)
' =========================================
package "共通出力型" <<output>> {
    class GeneratedPokemonData <<result>> {
        advance: number
        needle_direction: NeedleDirection
        source: GenerationSource
        lcg_seed: bigint
        pid: number
        species_id: number
        level: number
        nature: Nature
        sync_applied: boolean
        ability_slot: number
        gender: Gender
        shiny_type: ShinyType
        held_item_slot: HeldItemSlot
        ivs: Ivs
        moving_encounter?: MovingEncounterInfo
        special_encounter?: SpecialEncounterInfo
        encounter_result: EncounterResult
    }

    class GeneratedEggData <<result>> {
        advance: number
        needle_direction: NeedleDirection
        source: GenerationSource
        lcg_seed: bigint
        pid: number
        nature: Nature
        gender: Gender
        ability_slot: number
        shiny_type: ShinyType
        inheritance_*_stat/parent: number
        ivs: Ivs
    }

    class Ivs <<result>> {
        hp/atk/def/spa/spd/spe: number
    }

    enum "GenerationSource" as GenerationSource <<result>> {
        Fixed { base_seed: bigint }
        Multiple { base_seed, seed_index }
        Datetime { base_seed, datetime, timer0, vcount, key_code }
    }
}

' =========================================
' 依存関係 (Input → API)
' =========================================
' MtseedSearcher
MtseedSearchParams --> IvFilter
MtseedSearchBatch --> MtseedResult
MtseedResult --> Ivs

' MtseedDatetimeSearcher
MtseedDatetimeSearchParams --> DsConfig
MtseedDatetimeSearchParams --> TimeRangeParams
MtseedDatetimeSearchParams --> SearchRangeParams
MtseedDatetimeSearchParams --> SearchSegment
MtseedDatetimeSearchBatch --> MtseedDatetimeResult
MtseedDatetimeResult --> DatetimeParams
MtseedDatetimeResult --> SearchSegment

' NeedleSearcher
NeedleSearchParams --> SeedSource
NeedleSearchBatch --> NeedleSearchResult
NeedleSearchResult --> GenerationSource

' SeedSource 内部依存
SeedSource ..> DsConfig : Startup/StartupRange
SeedSource ..> DatetimeParams : Startup/StartupRange
SeedSource ..> SearchSegment : Startup
SeedSource ..> VCountTimer0Range : StartupRange

' Generator 内部依存 (想定)
GeneratedPokemonData --> Ivs
GeneratedPokemonData --> GenerationSource
GeneratedEggData --> Ivs
GeneratedEggData --> GenerationSource

@enduml
